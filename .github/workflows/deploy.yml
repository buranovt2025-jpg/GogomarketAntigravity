name: üöÄ Deploy to DigitalOcean

on:
  push:
    branches:
      - master
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîë Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            echo "üöÄ Starting GOGOMARKET deploy..."

            # –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            cd /root/gogomarket

            # Pull –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–¥
            echo "üì• Pulling latest code..."
            git pull origin master

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ backend
            cd backend

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º .env
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  .env not found! Copying from example..."
              cp .env.production.example .env
              echo "‚ö†Ô∏è  IMPORTANT: Edit /root/gogomarket/backend/.env with real values!"
            fi

            # Build –∏ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose
            echo "üê≥ Building and starting containers..."
            docker-compose up --build -d

            # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
            echo "‚è≥ Waiting for API to start..."
            sleep 15

            # Health check
            echo "üè• Health check..."
            curl -sf http://localhost:3000/health || (echo "‚ùå Health check failed!" && exit 1)

            echo "‚úÖ Deploy successful! API is up at http://${{ secrets.SSH_HOST }}"

      - name: üìä Notify deploy status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deploy to ${{ secrets.SSH_HOST }} ‚Äî SUCCESS"
          else
            echo "‚ùå Deploy FAILED ‚Äî check logs above"
          fi
